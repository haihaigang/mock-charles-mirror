<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Index of <%= dir%></title>
    <link rel="icon" type="favicon" href="/static/favicon.ico" />
    <style type="text/css">
      html,body {
        height: 100%;
        margin: 0;
      }
      .root {
        padding: 10px;
      }
      i.icon {
        display: block;
        height: 16px;
        width: 16px;
      }
      table tr {
        white-space: nowrap;
      }
      td.file-size {
        text-align: right;
        padding-left: 1em;
      }
      td.display-name {
        padding-left: 1em;
      }
      td.last-modified {
        padding-left: 1em;
      }
      i.icon-_blank {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAWBJREFUeNqEUj1LxEAQnd1MVA4lyIEWx6UIKEGUExGsbC3tLfwJ/hT/g7VlCnubqxXBwg/Q4hQP/LhKL5nZuBsvuGfW5MGyuzM7jzdvVuR5DgYnZ+f99ai7Vt5t9K9unu4HLweI3qWYxI6PDosdy0fhcntxO44CcOBzPA7mfEyuHwf7ntQk4jcnywOxIlfxOCNYaLVgb6cXbkTdhJXq2SIlNMC0xIqhHczDbi8OVzpLSUa0WebRfmigLHqj1EcPZnwf7gbDIrYVRyEinurj6jTBHyI7pqVrFQqEbt6TEmZ9v1NRAJNC1xTYxIQh/MmRUlmFQE3qWOW1nqB2TWk1/3tgJV0waVvkFIEeZbHq4ElyKzAmEXOx6gnEVJuWBzmkRJBRPYGZBDsVaOlpSgVJE2yVaAe/0kx/3azBRO0VsbMFZE3CDSZKweZfYIVg+DZ6v7h9GDVOwZPw/PoxKu/fAgwALbDAXf7DdQkAAAAASUVORK5CYII=");
      }

      i.icon-_page {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAmhJREFUeNpsUztv01AYPfdhOy/XTZ80VV1VoCqlA2zQqUgwMEErWBALv4GJDfEDmOEHsFTqVCTExAiiSI2QEKJKESVFFBWo04TESRzfy2c7LY/kLtf2d8+555zvM9NaI1ora5svby9OnbUEBxgDlIKiWjXQeLy19/X17sEtcPY2rtHS96/Hu0RvXXLz+cUzM87zShsI29DpHCYt4E6Box4IZzTnbDx7V74GjhOSfwgE0H2638K9h08A3iHGVbjTw7g6YmAyw/BgecHNGGJjvfQhIfmfIFDAXJpjuugi7djIFVI4P0plctgJQ0xnFe5eOO02OwEp2VkhSCnC8WOCdqgwnzFx4/IyppwRVN+XYXsecqZA1pB48ekAnw9/4GZx3L04N/GoTwEjX4cNH5vlPfjtAIYp8cWrQutxrC5Mod3VsXVTMFSqtaE+gl9dhaUxE2tXZiF7nYiiatJ3v5s8R/1yOCNLOuwjkELiTbmC9dJHpIaGASsDkoFQGJQwHWMcHWJYOmUj1OjvQotuytt5nHMLEGkCyx6QU384jwkUAd2sxJbS/QShZtg/8rHzzQOzSaFhxQrA6YgQMQHojCUlgnCAAvKFBoXXaHfArSCZDE0gyWJgFIKmvUFKO4MUNIk2a4+hODtDUVuJ/J732AKS6ZtImdTyAQQB3bZN8l9t75IFh0JMUdVKsohsUPqRgnka0tYgggYpCHkKGTsHI5NOMojB4iTICCepvX53AIEfQta1iUCmoTiBmdEri2RgddKFhuJoqb/af/yw/d3zTNM6UkaOfis62aUgddAbnz+rXuPY+Vnzjt9/CzAAbmLjCrfBiRgAAAAASUVORK5CYII=");
      }
      input {
        border: none;
        outline: none;
      }
      a:hover {
        color: #f00;
      }
      #domain-list a {
        position: relative;
        display: block;
        list-style: none;
        padding: 10px 20px;
      }
      #domain-list a.on {
        color: red;
        font-weight: bold;
      }
      #domain-list a.on::after {
        position: absolute;
        top: 15px;
        left: 8px;
        content: "@";
        font-size: 12px;
        color: #ddd;
      }

      .dialog-tools {
        position: absolute;
        top: 22px;
        right: 22px;
        z-index: 9;
      }
      .dialog-tools-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        color: #57606a;
        border-radius: 5px;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
      }

      .dialog-tools-btn:hover {
        background-color: #efefef;
      }
      .dialog-tools-btn.on{
        background-color: #e6e6e6;
      }
      .dialog-tools-list {
        position: absolute;
        top: 44px;
        right: 0;
        display: none;
        min-width: 100px;
        padding: 7px 0;
        background-color: #e6e6e6;
        box-shadow: -2px 2px 5px rgb(230 230 230 / 80%);
        border-radius: 5px 0 5px 5px;
      }
      .dialog-tools-list a {
        display: block;
        padding: 7px 10px;
        text-align: center;
      }

      #domain-add input {
        box-sizing: border-box;
        width: 100%;
        padding: 10px;
      }

    </style>
  </head>
  <body>
    <div class="root">
      <h1>Index of <%= dir%></h1>
      <table>
        <%files.forEach(function(file){%>
            <tr>
              <td><i class="icon icon-<%= file.isFile ? '_page' : '_blank'%>"></i></td>
              <td class="last-modified"><%= file.mtimeStr%></td>
              <td class="file-size"><code><% if (file.isFile){%><%=file.fileSizeStr%><%}%></code></td>
              <td class="display-name"><a href="<%=file.filePath%>"><%=file.filename%></a>
              <% if (file.isFile){%><a href="<%=file.editLink%>" title="编辑">...</a><%}%>
            </td>
            </tr>
        <%})%>
        <tr>
          <td><i class="icon"></i></td>
          <td class="last-modified"></td>
          <td class="file-size"><code></code></td>
          <td class="display-name">
              <a href="/admin" title="添加一个目录" id="btn-add-dir">++添加目录++</a>
              <form id="form-add-dir" style="display: none;" action="/admin/saveDir">
                <input class="form-control" type="text" name="url" placeholder="输入一个目录名称" autocomplete="off" />
                <input class="form-control" type="hidden" name="dir" value="<%= dir%>" />
              </form>
            </td>
          </tr>
          <tr>
            <td><i class="icon"></i></td>
            <td class="last-modified"></td>
            <td class="file-size"><code></code></td>
            <td class="display-name">
              <mcm-btn-add btn-text="++添加文件++" btn-title="添加一个文件" data-action="/admin/saveApi">
                <div slot="content">
                  <input class="form-control" type="text" name="url" placeholder="输入一个文件名称" autocomplete="off" />
                  <input class="form-control" type="hidden" name="content" value="{}" />
                  <button type="submit">submit</button>
                </div>
              </mcm-btn-add>
              <!-- <a href="/admin" title="添加一个文件" id="btn-add-file">++添加文件++</a>
              <form id="form-add-file" style="display: none;" action="/admin/saveApi">
                <input class="form-control" type="text" name="url" placeholder="输入一个文件名称" autocomplete="off" />
                <input class="form-control" type="hidden" name="content" value="{}" />
              </form> -->
          </td>
        </tr>
      </table>

      <br />
      <p>Mock Charles Mirror <a href="#" id="btn-change-doamin">@<%= mockDomain%></a></p>
    </div>
    <div id="tools" class="dialog-tools">
      <summary class="dialog-tools-btn btn-octicon">
        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"
          class="octicon octicon-list-unordered">
          <path fill-rule="evenodd"
            d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z">
          </path>
        </svg>
      </summary>
      <div class="dialog-tools-list">
        <a href="#" data-action="add-domain">新增域名</a>
        <a href="#" data-action="open-domain">切换域名</a>
        <a href="/admin">新增接口</a>
      </div>
    </div>
    <mcm-dialog id="domain-add" style="display: none;">
      <span slot="title">新增一个域名</span>
      <form id="form-add-domain" action="/admin/addMockDomain" slot="content">
        <input class="form-control" type="text" name="domain" placeholder="输入一个域名名称" autocomplete="off" />
      </form>
    </mcm-dialog>
    <mcm-dialog id="domain-list" style="display: none;">
      <span slot="title">点击可切换不同域名</span>
      <div slot="content"></div>
    </mcm-dialog>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <%- include('templates/tpl-mcm-dialog'); -%>
    <script src="/static/components/mcm-dialog.js"></script>
    <%- include('templates/tpl-mcm-btn-add'); -%>
    <script src="/static/components/mcm-btn-add.js"></script>
    <script type="text/javascript">
      let currentDomain = '<%= mockDomain%>'
      function setupForm($btn) {
        var $form = $btn.next()
        $btn.click(function (e) {
          e.preventDefault()
          $form.show().find('input').focus()
          $btn.hide()
          isAddFile = false
        })

        $form.find('input').keyup(function(e) {
          if (e.keyCode === 27) {
            $form.hide()
            $btn.show()
          }
        }).blur(function(e) {
          $form.hide()
          $btn.show()
        })

        $form.submit(function (e) {
          e.preventDefault()

          let formData = getFormData($(this))

          if (!formData.url) return

          return $.ajax({
            url: $(this).attr('action'),
            data: formData,
            method: "post",
          }).then(function (res) {
            location.reload()
          });
        })
      }

      setupForm($('#btn-add-dir'))
      setupForm($('#btn-add-file'))

      function getFormData ($form) {
          let formArray = $form.serializeArray();
          let result = {};
          formArray.forEach((item) => {
            result[item.name] = item.value;
          });
          return result;
        }

      function openDomain(params) {
        $.ajax({
          url: '/admin/getMockDomains'
        }).then(function (res) {
          let html = ''
          res.forEach(function (name) {
            html += `<a href="#" class="${currentDomain === name ? "on" : "off"}">${name}</a>`
          })
          $('#domain-list div').html(html)
          document.querySelector('#domain-list').open()
        })
      }
      
      $('#btn-change-doamin').click(function(e){
        e.preventDefault()
        openDomain()
      })
      $('#domain-list').on('click', 'a', function(e){
        e.preventDefault()
        e.stopPropagation()
        if ($(this).hasClass('on')) {
          return
        }

        $.ajax({
          url: '/admin/changeMockDomain',
          data: {
            domain: e.target.innerHTML
          },
          type: 'POST'
        }).then(function (res) {
          location.reload()
        })
      })

      $('#tools').click(function(e) {
        e.stopPropagation()
      })

      $('.dialog-tools-btn').click(function(e) {
        $(this).toggleClass('on')
        $('.dialog-tools-list').toggle()
      })
      $('body').click(function(e) {
        $('.dialog-tools-btn').removeClass('on')
        $('.dialog-tools-list').hide()
      })

      $('#tools').on('click', '.dialog-tools-list a', function(e){
        e.preventDefault()
        let action = $(this).data('action')
        switch (action) {
          case 'add-domain':
            // $('#domain-add').show()
            document.querySelector('#domain-add').open()
            break;
          case 'open-domain':
            openDomain()
            break;
        
          default:
            break;
        }
      })

      $('#domain-add form').submit(function (e) {
          e.preventDefault()

          let formData = getFormData($(this))

          if (!formData.domain) return

          return $.ajax({
            url: $(this).attr('action'),
            data: formData,
            method: "post",
          }).then(function (res) {
            location.reload()
          });
        })
    </script>
  </body>
</html>
